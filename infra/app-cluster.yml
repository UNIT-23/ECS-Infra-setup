AWSTemplateFormatVersion: '2010-09-09'
Description: container cluster on ECS, loadbalancer, security groups and cloudwatch

Resources:
  
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: 'Cluster'

  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: ecs-loadbalancer
      Subnets:
        - !ImportValue 'Subnet1'
        - !ImportValue 'Subnet2'
      SecurityGroups:
        - !Ref ECSSecurityGroup

  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for loadbalancer to services on ECS
      VpcId: !ImportValue 'VPC'
      # By default no traffic is allowed into the instance so we have to define explicitly 
      SecurityGroupIngress:
        - CidrIp: 0.0.0.0/0
          IpProtocol: -1
        

  LoadBalancerListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      # The Amazon Resource Name (ARN) of the load balancer to associate with the listener.
      LoadBalancerArn: !Ref LoadBalancer
      # The protocol that clients must use to send requests to the listener.
      Protocol: HTTP
      # The port on which the listener listens for requests.
      Port: 80
      # The default actions that the listener takes when handling incoming requests.
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref DefaultTargetGroup

 

  DefaultTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      # Unique name per account per region
      Name: default
      VpcId: !ImportValue 'VPC'
      # The protocol to use for routing traffic to the targets.
      Protocol: 'HTTP'
      # The port on which the targets receive traffic.
      Port: '80'  

  # CloudWatchLogsGroup:
  #   Type: AWS::Logs::LogGroup
  #   Properties:
  #     # A name for the log group. 
  #     LogGroupName: 'apis'
  #     # The number of days log events are kept in CloudWatch Logs
  #     RetentionInDays: 1

  ContainerSecurityGroup:
    Type: AWS::EC2::SecurityGroup      
    Properties:
     VpcId: !ImportValue 'VPC'
     GroupDescription: for ecs containers
     SecurityGroupIngress:
       - SourceSecurityGroupId: !Ref 'ECSSecurityGroup'
         IpProtocol: -1


Outputs:
  
  Cluster:
    Value: !Ref ECSCluster
    Export:
      Name: 'ECSCluster'

  Listener:
    Description: listener port 80
    Value: !Ref LoadBalancerListener
    Export:
      Name: 'Listener'

  ContainerSecurityGroup:
    Description: container security group
    Value: !Ref ContainerSecurityGroup
    Export:
      Name: 'ContainerSecurityGroup'

  LoadBalancerDNS:
    Description: Domain name for the loadbalancer
    Value: !GetAtt LoadBalancer.DNSName
    Export:
      Name: 'DomainName'

   DefaultTargetGroup:
    Description: DefaultTargetGroup for loadbalancer
    Value: !Ref DefaultTargetGroup
    Export:
      Name: 'DefaultTargetGroup'
